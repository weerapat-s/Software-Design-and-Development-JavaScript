name: Close Late Pull Requests
on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  issues: write

jobs:
  close_late_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is late
        id: check_date
        run: |
          # กำหนดวันกำหนดส่ง (ISO 8601 format)
          DUE_DATE="2026-02-25T23:59:59Z"
          # ดึงเวลาที่สร้าง PR
          PR_DATE="${{ github.event.pull_request.created_at }}"
          
          echo "Due date: ${DUE_DATE}"
          echo "PR created: ${PR_DATE}"
          
          # เปรียบเทียบ String (เนื่องจากเป็น ISO 8601 สามารถเทียบกันตรงๆ ได้)
          if [[ "${PR_DATE}" > "${DUE_DATE}" ]]; then
            echo "is_late=true" >> $GITHUB_OUTPUT
            echo "Result: PR is late!"
          else
            echo "is_late=false" >> $GITHUB_OUTPUT
            echo "Result: PR is on time."
          fi

      - name: Close late PR
        if: steps.check_date.outputs.is_late == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prAuthor = context.payload.pull_request.user.login;
            const createdAt = context.payload.pull_request.created_at;

            try {
              // 1. เพิ่ม Comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `⚠️ **Submission Deadline Exceeded**\n\nThis pull request was submitted after the due date (**February 25, 2026 at 23:59:59 UTC**) and has been automatically closed.\n\n**Submission Details:**\n- PR Title: ${prTitle}\n- Author: @${prAuthor}\n- Submitted: ${createdAt}\n- Due Date: February 18, 2026 23:59:59 UTC\n\nIf you believe this was closed in error, please contact the instructor.`
              });
              
              // 2. ปิด PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed'
              });
              
              console.log(`✅ PR #${prNumber} closed successfully.`);
            } catch (error) {
              core.setFailed(`❌ Error: ${error.message}`);
            }
